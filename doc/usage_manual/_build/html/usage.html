<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Configuration and Usage &mdash; Asterisell 5 documentation</title>
    
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Asterisell 5 documentation" href="index.html" />
    <link rel="next" title="FAQ and HOWTOS" href="FAQ.html" />
    <link rel="prev" title="Management" href="management.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="FAQ.html" title="FAQ and HOWTOS"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="management.html" title="Management"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Asterisell 5 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="configuration-and-usage">
<h1>Configuration and Usage<a class="headerlink" href="#configuration-and-usage" title="Permalink to this headline">¶</a></h1>
<p>Each page of the application has an extensive online help. This manual will not repeat this information.</p>
<div class="section" id="application-recurring-concepts">
<h2>Application Recurring Concepts<a class="headerlink" href="#application-recurring-concepts" title="Permalink to this headline">¶</a></h2>
<p>Customers are defined using nested trees, for example &#8220;Acme Organization/Accounting Office/John Smith&#8221;.</p>
<p>Also CDR rating rules are defined using nested trees, for example &#8220;acme-vendor-telecom/outgoing/emergency-number&#8221;.</p>
<p>Whenever possible a complete history of the past is retained. This is
the case for rates, services, customer price categories, customer organization structure.</p>
<p>So the common workflow is not modifying information in-place,
but adding new information (rates, price-categories and so on...),
specifying when they became valid.
Due to this, the user interface for administrators
is more complex respect a traditional user interface where there are only
in-place changes. But there are many advantages:</p>
<ul class="simple">
<li>changes of rates and services can be planned in the future;</li>
<li>CDRs can be re-rated in the past, applying the old rate
specifications;</li>
<li>history of applied rates, and services is retained;</li>
</ul>
<p>Asterisell uses a conservative approach about CDR rating.
A rather big part of Asterisell code is devoted to recognizing error
conditions, and the application favour false alarms, respect silently
calculating the wrong cost/income.</p>
<p>Every reported error contains:</p>
<ul class="simple">
<li>the error level (info, warning, error, critical)</li>
<li>the description</li>
<li>the effect on the system</li>
<li>the suggested solution for fixing it</li>
</ul>
</div>
<div class="section" id="configuration-of-the-cdr-rating-process">
<h2>Configuration of the CDR Rating Process<a class="headerlink" href="#configuration-of-the-cdr-rating-process" title="Permalink to this headline">¶</a></h2>
<div class="section" id="overview">
<h3>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h3>
<p>The configuration is an iterative process:</p>
<ul class="simple">
<li>initial configuration attempt</li>
<li>read Asterisell error messages</li>
<li>improve configuration, until there are no more error messages</li>
</ul>
<p>Asterisell refuses to process CDRs if configurations are not 100%
correct. This is a safety measure for being sure that there are no CDRs
billed in a bad way. Hopefully the rich and complete error messages of
Asterisell, can guide you to the resolution of problems.</p>
</div>
<div class="section" id="paid-support-for-initial-configuration">
<h3>Paid Support for Initial Configuration<a class="headerlink" href="#paid-support-for-initial-configuration" title="Permalink to this headline">¶</a></h3>
<p>Because initial configuration of Asterisell is the more complex task to
do, you can describe your needs to <a class="reference external" href="mailto:support&#37;&#52;&#48;asterisell&#46;com">support</a> and the
Asterisell support can customize and configure Asterisell for you. Then
the maintenance of a properly configured Asterisell instance is easier.</p>
</div>
<div class="section" id="cdrs-providers">
<h3>CDRs Providers<a class="headerlink" href="#cdrs-providers" title="Permalink to this headline">¶</a></h3>
<p>First CDRs must be imported inside Asterisell.</p>
<p>CDRs can be retrieved from different sources/providers. A CDR provider
must be defined in <code class="docutils literal"><span class="pre">Params-&gt;CDRs</span> <span class="pre">Providers</span></code>.</p>
<p>A CDR provider is some computer related medium (a directory, a database
table, some message queue, an FTP account, etc..) containing CDRs to
import into Asterisell. It is the name of a computer communication
channel, used for retrieving CDRs.</p>
<p>Note that a CDR provider is not a Vendor. A Vendor is a fiscal entity
that routes CDRs, and that can requires payments for this service.</p>
<p>In many configurations there is a one to one match between a Vendor and
CDR provider. For example a Vendor X can put CDRs on an FTP account. But
there can be configurations where the same CDR provider is used from
many Vendors, or a Vendor uses more than one CDR provider.</p>
<p>Communication Channels types are created in
<code class="docutils literal"><span class="pre">Params</span> <span class="pre">-&gt;</span> <span class="pre">Communication</span> <span class="pre">Channels</span></code>. A cummunication channel type is
something like:</p>
<ul class="simple">
<li>SIP Calls</li>
<li>Fixed Line Calls</li>
<li>Mobile Calls</li>
<li>ENUM Calls</li>
<li>etc..</li>
</ul>
<p>Vendors are created in <code class="docutils literal"><span class="pre">Rates</span> <span class="pre">-&gt;</span> <span class="pre">Vendors</span></code> menu.</p>
<p>A Communication Channel is a value inside CDR identifying the channel
used for routing the call.</p>
<p>Association between a Communication Channel, and a Vendor and the
corresponding Communication Channel Type are done in the menu
<code class="docutils literal"><span class="pre">Rates</span> <span class="pre">-&gt;</span> <span class="pre">Channels</span></code>. By default an imported CDR, is associated to a
Vendor and a Communcation Channel Type according the content of this
table. But there can be specific importing methods, assigning predefined
Vendors or Communication Channel Types to a CDR.</p>
<p>Up to date rates can not match on CDR provider, but only on channel. See
#1909.</p>
</div>
<div class="section" id="cdrs-file-name">
<h3>CDRs File Name<a class="headerlink" href="#cdrs-file-name" title="Permalink to this headline">¶</a></h3>
<p>A CDRs source file has a name like
<code class="docutils literal"><span class="pre">file1.some-cdr-provider__logical-type__version</span></code>, where:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">file1</span></code> is some file name to use. It should be distinct, for
avoiding clash during importing</li>
<li><code class="docutils literal"><span class="pre">some-cdr-provider</span></code> is a name of a configure cdr-provider. In case
there is no configured cdr-provider, Asterisell signals the problem,
and does not import the file. The file will be imported later,
automatically, when the problem is resolved</li>
<li><code class="docutils literal"><span class="pre">logical-type</span></code> is the name of some type of file to import. If the
type is not recognized, Asterisell signals the problem, and the file
will be imported later, when the problem is resolved</li>
<li><code class="docutils literal"><span class="pre">version</span></code> is the name of the version of the type used. So the same
type, can have different versions, with slightly different formats</li>
</ul>
</div>
<div class="section" id="cdrs-status-files">
<h3>CDRs Status Files<a class="headerlink" href="#cdrs-status-files" title="Permalink to this headline">¶</a></h3>
<p>A CDRs CDRs status file name is like
<code class="docutils literal"><span class="pre">file1.2015-01-01.some-cdr-provider__logical-type__version</span></code>, where:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">2015-01-01</span></code> is a status file, with all the calls of the day</li>
<li><code class="docutils literal"><span class="pre">2015-01-00</span></code> is a status file, with all the calls of the month</li>
<li><code class="docutils literal"><span class="pre">2015-00-00</span></code> is a status file, with all the calls of the year</li>
<li>the other parts of the file name follow the same convention of CDRs
file name</li>
</ul>
<p>The importing of a status file:</p>
<ul class="simple">
<li>delete all the calls in the status file time-frame, of the same
provider</li>
<li>insert the calls in the status file</li>
<li>the net effect is replacing the calls in the status time frame, with
the content of the status file</li>
</ul>
</div>
<div class="section" id="manual-importing-of-cdrs-files">
<h3>Manual Importing of CDRs files<a class="headerlink" href="#manual-importing-of-cdrs-files" title="Permalink to this headline">¶</a></h3>
<p>The source CDRs files must be put inside the directory
<code class="docutils literal"><span class="pre">data_files/messages/input</span></code>. They must have a name with the previously
described format, otherwise Asterisell signals the problem, and it does
not import them.</p>
<p>Manual importing of CDRs files is not the suggested way. It is preferred
configuring some import jobs. If you import them manually, make sure to:</p>
<ul class="simple">
<li>copy the files in a tmp directory inside the same filesystem</li>
<li>move the files in the Asterisell directory
<code class="docutils literal"><span class="pre">data_files/messages/input</span></code></li>
<li>file moving in Linux is an atomic operation, if and only if the
source and destination directories are on the same file system</li>
<li>doing so, you are sure that Asterisell will process the entire
content of the file, and there are no conflicts</li>
<li>Asterisell jobs take care of this automatically</li>
</ul>
</div>
<div class="section" id="automatic-importing-of-cdrs-files">
<h3>Automatic Importing of CDRs files<a class="headerlink" href="#automatic-importing-of-cdrs-files" title="Permalink to this headline">¶</a></h3>
<p>You can add jobs into Asterisell, for importing files from different
communication channel sources like FTP, WebDAV, external database
tables, and so on.</p>
<p>TODO continue</p>
</div>
<div class="section" id="how-cdrs-source-file-are-saved-internally">
<h3>How CDRs Source File are Saved Internally<a class="headerlink" href="#how-cdrs-source-file-are-saved-internally" title="Permalink to this headline">¶</a></h3>
<p>CDRs source file are processed from Asterisell, and imported in
Asterisell internal table <code class="docutils literal"><span class="pre">ar_source_cdr</span></code>. This table store the source
CDRs:</p>
<ul class="simple">
<li>in a compressed format saving a lot of space</li>
<li>bakc in their original format, when decompressed, allowing a complete
reprocessing if the rules about their processing changes</li>
</ul>
</div>
<div class="section" id="how-importing-from-csv-files">
<h3>How Importing From CSV Files<a class="headerlink" href="#how-importing-from-csv-files" title="Permalink to this headline">¶</a></h3>
<p>TODO continue</p>
</div>
<div class="section" id="pseudo-csv-file">
<h3>Pseudo CSV File<a class="headerlink" href="#pseudo-csv-file" title="Permalink to this headline">¶</a></h3>
<p>Asterisell supports a pseudo CSV-file format:</p>
<ul class="simple">
<li>multi lines are not supported</li>
<li>it extracts first a distinct line from a file</li>
<li>it process it like a CSV file line</li>
</ul>
<p>This format is useful in case there can be errors in the CSV files,
because it minimize the number of unrecognized entries, in case of a
missing ending quote.</p>
</div>
<div class="section" id="how-importing-from-collector-table">
<h3>How Importing From Collector Table<a class="headerlink" href="#how-importing-from-collector-table" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">apps/asterisell/lib/jobs/data_file_processing/ImportCDRSFromDatabase.php</span></code>
is the abstract Job to use for retrieving CDRs from a collector table.</p>
<p>It:</p>
<ul class="simple">
<li>reads CDRs on a table of a database, that is acting like a queue of
CDRs to process,</li>
<li>convert to CSV files the CDRs to process,</li>
<li>put the generated CSV files on the input queue of Asterisell,</li>
<li>remove (optionally) older CDRs already exported to Asterisell,
managing the table as a queue,</li>
</ul>
<p>It is an abstract class, so:</p>
<ul class="simple">
<li>a concrete class/job must be inherited from it,</li>
<li>the inherited job, must define the missing methods, respecting the
requirements on method headers descriptions,</li>
<li>the inherited job must be added to the list of jobs to process before
rating, adding it to the <code class="docutils literal"><span class="pre">import_cdrs_jobs</span></code> option of the instance
configuration file</li>
</ul>
<p>One or more jobs of this type can be added, without conflict.</p>
<div class="section" id="workflow-of-cdrs-processing">
<h4>Workflow of CDRs Processing<a class="headerlink" href="#workflow-of-cdrs-processing" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><div class="highlight"><pre><span></span>[VoIP Servers] ---put CDRs on---&gt; [local collector table]
... ---Asterisell exports to---&gt; [CSV files]
... ---rated to---&gt; [Rated CDR records]
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">CSV</span> <span class="pre">Files</span></code> are archived in the file-system, and directly
referenced and managed from Asterisell. The Asterisell backup procedures
can take care also of these files.</p>
<p><code class="docutils literal"><span class="pre">Rated</span> <span class="pre">CDR</span> <span class="pre">Records</span></code> are compressed, and indexed. They are managed from
Asterisell application, and from Asterisell backup procedures.</p>
</div>
<div class="section" id="is-exported-to-asterisell-flag-field">
<h4>&#8220;is_exported_to_asterisell&#8221; flag field<a class="headerlink" href="#is-exported-to-asterisell-flag-field" title="Permalink to this headline">¶</a></h4>
<p>You should be able to add to the CDR source table on the collector, a field like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>ALTER TABLE your_table_name
ADD COLUMN is_exported_to_asterisell TINYINT default 0 NOT NULL,
ADD INDEX is_exported_to_asterisell_index(is_exported_to_asterisell);
</pre></div>
</div>
<p>This field will be used from Asterisell for importing only new source
CDRs. The source table will work like a queue.</p>
</div>
<div class="section" id="tables-on-external-databases">
<h4>Tables on External Databases<a class="headerlink" href="#tables-on-external-databases" title="Permalink to this headline">¶</a></h4>
<p>An external database is a database that is not on the same Linux
instance where Asterisell is installed.</p>
<p>TODO continue</p>
</div>
<div class="section" id="tables-on-the-same-host-and-database-server">
<h4>Tables on the same Host and Database Server<a class="headerlink" href="#tables-on-the-same-host-and-database-server" title="Permalink to this headline">¶</a></h4>
<p>If the table with source CDRs is on the same Host and Database Server,
you can optimize further the processing of source CDRs.</p>
<p>First show the format of the table, executing something like</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>show create table your_table_name;
</pre></div>
</div>
<p>It is important the last line of the table creation:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>ENGINE=InnoDB AUTO_INCREMENT=51438 DEFAULT CHARSET=latin1
</pre></div>
</div>
<p>Asterisell uses the TokuDB engine:</p>
<ul class="simple">
<li>it can compress data</li>
<li>it is fast and reliable</li>
<li>it is studied for big data</li>
<li>it is 100% compatbile with all the SQL and MySQL API commands issued
to a InnoDB engine</li>
</ul>
<p>So you can switch the engine used for the table, to TokuDB. The
application writing to it will not notice the difference.</p>
<p>If you have not many source CDRs, and you can interrupct the CDR stream
flow, you can execute a command like</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>ALTER TABLE your_source_cdrs_table_name ENGINE=tokudb COMPRESSION=tokudb_quicklz,DEFAULT CHARACTER SET = latin1;
</pre></div>
</div>
<p>specifying the same character set of your original table. Asterisell
uses UTF8 character set for its tables, but during exporting and
importing, it can convert between different character-sets.</p>
<p>If you cannot interrupt the stream of CDRs, consult the assistance. It
is possibile copying on the fly old and new CDRs, and them executing a
fast switch.</p>
</div>
<div class="section" id="fix-errors-in-imported-cdrs">
<h4>Fix Errors in Imported CDRs<a class="headerlink" href="#fix-errors-in-imported-cdrs" title="Permalink to this headline">¶</a></h4>
<p>If CDRs contains errors, and the error is in Asterisell code processing
them:</p>
<ul class="simple">
<li>ask for <a class="reference external" href="mailto:support&#37;&#52;&#48;asterisell&#46;com">support</a>, specifying how the CDRs must be processed;</li>
<li>install the new version of Asterisell;</li>
<li>rerate CDRs;</li>
</ul>
<p>If the source VoIP server are configured in a bad way, and there are
errors in the content of the collector table:</p>
<ul class="simple">
<li>TODO description to improve</li>
<li>use CSV utility functions shipped with Asterisell, for fixing errors
directly in CSV files;</li>
<li>rerate CDRs;</li>
</ul>
<p>This workflow is needed because:</p>
<ul class="simple">
<li>CDRs are rerated starting from CSV files;</li>
<li>the collector table is used only as an intermediate queue for CDRs;</li>
<li>new CSV files add only new info, and do not delete old info;</li>
<li>in place replacing of CSV file content, and a rerating command, is a
method for updating CDRs, because all CDRs in the timeframe are
deleted, and then new version of CDRs are inserted;</li>
</ul>
</div>
</div>
</div>
<div class="section" id="specification-of-rating-plans">
<h2>Specification of Rating Plans<a class="headerlink" href="#specification-of-rating-plans" title="Permalink to this headline">¶</a></h2>
<p>In Asterisell there are two main rating plans: <code class="docutils literal"><span class="pre">main-cost-rate</span></code>, and
<code class="docutils literal"><span class="pre">main-income-rate</span></code>. They specify the rating plan logic. They can have
references to rating plan details, for example to CSV files. Usually you
spend some time initially to specify main rating plans, but then you
modify with time mainly the rating plan details (the CSV files), and
rarely the main rating plan logic.</p>
<p>You can study:</p>
<ul class="simple">
<li>the <a class="reference internal" href="#tutorial-csv-rates"><span>Tutorial on CSV Rates</span></a></li>
<li>the <a class="reference internal" href="#tutorial-main-rate-plans"><span>Tutorial on Main Rate Plans</span></a></li>
<li>the complete <a class="reference internal" href="#rate-plan-specification-language"><span>Rate Plan Specification Language</span></a></li>
</ul>
<p>Then you can create your plans starting from the examples in tutorials,
and adapting them.</p>
<p>If you have few time, you can describe your rating plan to Asterisell
assistance, and we will specify it for you.</p>
</div>
<div class="section" id="call-reporting-mode">
<h2>Call Reporting Mode<a class="headerlink" href="#call-reporting-mode" title="Permalink to this headline">¶</a></h2>
<p>In Call Reporting Mode, Asterisell is not used for billing the calls.
Calls have only a cost.</p>
<p>The user must specify only the <code class="docutils literal"><span class="pre">main-income-rate</span></code>. It is called
<code class="docutils literal"><span class="pre">income</span></code> but it is rating the costs of calls. The <code class="docutils literal"><span class="pre">income</span></code> rate is
preferred because it is more powerful and it can contains also bundle
rate parameters.</p>
<p>The resulting CDRs will have an income and cost equals to the result of
the rate.</p>
</div>
<div class="section" id="automatic-rerating-of-calls">
<h2>Automatic Rerating of Calls<a class="headerlink" href="#automatic-rerating-of-calls" title="Permalink to this headline">¶</a></h2>
<p>If rating params are changed, Asterisell schedule automatically a
rerating event, starting from the official call date.</p>
</div>
<div class="section" id="tutorial-on-csv-rates">
<span id="tutorial-csv-rates"></span><h2>Tutorial on CSV Rates<a class="headerlink" href="#tutorial-on-csv-rates" title="Permalink to this headline">¶</a></h2>
<p>This is a CSV rate, with prices specified by minute, and applied by
second. The prices are in Italian format: with &#8221;,&#8221; as decimal separator.</p>
<p><img alt="image0" src="tut_a_01.png" /></p>
<p>We check if the rate format is one of the supported formats</p>
<p><img alt="image1" src="tut_a_02.png" /></p>
<p>Yes it is supported:</p>
<p><img alt="image2" src="tut_a_03.png" /></p>
<p>In case it is not supported, you can:</p>
<ul class="simple">
<li>contact the assistance, for adding the format to the application</li>
<li>convert the CSV file to one of the supported formats</li>
</ul>
<p>Now we open the <code class="docutils literal"><span class="pre">Rates</span> <span class="pre">-&gt;</span> <span class="pre">Rates</span></code> menu, and we create a new rate. We
upload the CSV file, specifying also its format.</p>
<p><img alt="image3" src="tut_a_06.png" /></p>
<p>The CSV file alone is not sufficient for rating the calls. We had to
specify a rate plan, classifying the calls by type, and applying the
correct rating method. The default name for these rates is
<code class="docutils literal"><span class="pre">main-income-rate</span></code>, and the default type is
<code class="docutils literal"><span class="pre">rate-plan-specification</span></code>. Don&#8217;t worry: if you don&#8217;t specify this
rate, the application will advise you.</p>
<p>So in <code class="docutils literal"><span class="pre">Rates</span> <span class="pre">-&gt;</span> <span class="pre">Rates</span></code> we insert</p>
<p><img alt="image4" src="tut_a_06.png" /></p>
<p>and we specify this rate plan</p>
<p><img alt="image5" src="tut_a_04.png" /></p>
<p>After specifying it, Asterisell schedules an automatic rerating of
unbilled calls.</p>
<p><img alt="image6" src="tut_a_08.png" /></p>
<p>Every rating error is reported.</p>
<p>We can inspect a rated call</p>
<p><img alt="image7" src="tut_a_10.png" /></p>
<p><img alt="image8" src="tut_a_11.png" /></p>
<p>Usually price-lists changes over time. We can modify the CSV file:</p>
<p><img alt="image9" src="tut_a_12.png" /></p>
<p>Now we upload the new version of CSV file, selecting the current version</p>
<p><img alt="image10" src="tut_a_13.png" /></p>
<p>We upload the new version, specifying the date on which it takes effect:</p>
<p><img alt="image11" src="tut_a_14.png" /></p>
<p>We can see that there are the two version of the same CSV file,
applicable at different call-dates:</p>
<p><img alt="image12" src="tut_a_15.png" /></p>
<p>We have not touched the <code class="docutils literal"><span class="pre">main-income-rate</span></code>, because usually the main
rate plan does not change, but only the CSV files with the details of
the rates.</p>
<p>An automatic rerating is scheduled, and we can inspect the differences</p>
<p><img alt="image13" src="tut_a_16.png" /></p>
<p><img alt="image14" src="tut_a_17.png" /></p>
</div>
<div class="section" id="tutorial-on-main-rate-plans">
<span id="tutorial-main-rate-plans"></span><h2>Tutorial on Main Rate Plans<a class="headerlink" href="#tutorial-on-main-rate-plans" title="Permalink to this headline">¶</a></h2>
<div class="section" id="cost-rates">
<h3>Cost Rates<a class="headerlink" href="#cost-rates" title="Permalink to this headline">¶</a></h3>
<div class="section" id="free-incoming-and-internal-calls">
<h4>Free Incoming and Internal Calls<a class="headerlink" href="#free-incoming-and-internal-calls" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><div class="highlight"><pre><span></span>rate {
  id: free-incoming
  match-call-direction: incoming
}

rate {
  id: free-internal
  match-call-direction: internal
}
</pre></div>
</div>
</div>
<div class="section" id="multiple-vendors">
<h4>Multiple Vendors<a class="headerlink" href="#multiple-vendors" title="Permalink to this headline">¶</a></h4>
<p>You can have multiple vendors (also called suppliers), that you use for
routing the VoIP calls.</p>
<p>You list your vendors, using the <code class="docutils literal"><span class="pre">Rates</span> <span class="pre">-&gt;</span> <span class="pre">Vendors</span></code> menu.</p>
<p>Every CDR has a communication channel. During CDR processing you can
specify in <code class="docutils literal"><span class="pre">Rates</span> <span class="pre">-&gt;</span> <span class="pre">Channels</span></code> how to associate a communication
channel name to the Vendor. When a CDR has the specified communication
channel, then it is considered as routed from the specified Vendor.</p>
<p>Note that are possible also more sophisticated associations between CDRs
and Vendors, but you must contact the assistance for this.</p>
<p>Then in the rate plan you specify how to rate the CDRs according
different vendors:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>rate {
  id: outgoing-rate
  match-call-direction: outgoing

  rate {
    id: vendor1-rate
    match-vendor: vendor1
    external-rate {
      id: csv
      use: vendor1-csv-details
      set-cost-for-minute: this
    }
  }

  rate {
    id: vendor2-rate
    match-vendor: vendor2
    external-rate {
      id: csv
      use: vendor2-csv-details
      set-cost-for-minute: this
    }
  }
}
</pre></div>
</div>
</div>
</div>
<div class="section" id="income-rates">
<h3>Income Rates<a class="headerlink" href="#income-rates" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id1">
<h4>Free Incoming and Internal Calls<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><div class="highlight"><pre><span></span>rate {
  id: free-incoming
  match-call-direction: incoming
}

rate {
  id: free-internal
  match-call-direction: internal
}
</pre></div>
</div>
</div>
<div class="section" id="rate-according-customer-price-category">
<h4>Rate according Customer Price Category<a class="headerlink" href="#rate-according-customer-price-category" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><div class="highlight"><pre><span></span>rate {
  id: outgoing
  match-call-direction: outgoing

  rate {
    id: wholesale
    match-price-category: wholesale

    external-rate {
      id: wholesale
      use: sell-wholesale
      set-cost-for-minute: this
    }
  }
}
</pre></div>
</div>
</div>
</div>
<div class="section" id="todo-continue">
<h3>TODO continue<a class="headerlink" href="#todo-continue" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="rate-plan-specification-language">
<span id="id2"></span><h2>Rate Plan Specification Language<a class="headerlink" href="#rate-plan-specification-language" title="Permalink to this headline">¶</a></h2>
<div class="section" id="normal-rates">
<h3>Normal Rates<a class="headerlink" href="#normal-rates" title="Permalink to this headline">¶</a></h3>
<p>The rate plan contains nested rules. There can be one or more rates at
the root level, and each rate can have arbirtrary nested children rates.</p>
<p>This rate plan is the entry point for calculating the cost or income of
a CDR, but it can contains references to other rate plans, like CSV
files.</p>
<p>This is an example of rate specification:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>rate {
  id: outgoing

  match-call-direction: outgoing

  rate {
    id: free-emergency-telephone-numbers

    match-telephone-number: 118,113,11X
  }

  rate {
    id: default

    match-price-category: normal
    set-cost-on-call: 0.05

    external-rate {
      id: csv-1
      use: csv-1
    }
  }

  rate {
    id: discounted

    match-price-category: discounted
    set-cost-on-call: 0.05

    external-rate {
      id: csv-discounted-2
      use: csv-discounted-2
    }
  }
}

rate {
  id: free-incoming

  match-call-direction: incoming
}

rate {
  id: free-internal
  match-call-direction: internal
}
</pre></div>
</div>
<div class="section" id="specification">
<h4>Specification<a class="headerlink" href="#specification" title="Permalink to this headline">¶</a></h4>
<p>In these specification notes:</p>
<ul class="simple">
<li>&#8220;[...]&#8221; is used only as documentation placeholder, for documenting
the possible values to insert.</li>
<li>A reference name is something like &#8220;some-name&#8221;,
&#8220;another_example_of_name&#8221;,
&#8220;some_name/with_an_implicit/hierarchy_notation&#8221;.</li>
</ul>
<p>The specification is</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>rate {
  # &quot;rate&quot; is a rate that can be applied to a CDR, and that can calc its cost/income.


  id: [reference]
  # a short internal reference name, used also in debug sessions for
  # discovering which rate is applied to a CDR.

  #
  # Specify on which CDRs the rate is applicable
  #

  # All these matches are optionals.

  match-communication-channel: [list of communication channel types]
  # if the CDR match one of the channels in the list, this rate can be applied

  match-vendor: [list of vendors]
  # if the CDR match one of the vendors in the list, this rate can be applied

  match-price-category: [list of price categories]
  # see notes on &quot;Rates-&gt;Price Categories&quot; section, on how to model hierarchical price categories.

  match-call-direction: [outgoing|incoming|internal|system]

  match-telephone-number: [list of telephone numbers]
  # The external telephone number:
  #   * the called telephone number for outgoing and internal calls,
  #   * the calling telephone number for incoming calls.
  #
  # Telephone numbers are expressed in the same format used for specifying internal extensions,
  # so something like &quot;123,123X,123X*,123*,123\X\*&quot;,
  # where &quot;X&quot; stays for any character,
  #       &quot;*&quot; stays for zero or more characters.
  # &quot;\\\\&quot; is the quotation for the &quot;\\&quot; character.
  # &quot;\,&quot; is the quotation for the &quot;,&quot; character
  # &quot; 123, 456&quot; is parsed into extensions &quot;123&quot;, and &quot;456&quot;
  # &quot; 123, 4 5 6&quot; is parsed into extensions &quot;123&quot;, and &quot;4 5 6&quot;
  # &quot;\ 123, \ 456&quot; is parsed into extensions &quot; 123&quot;, and &quot; 456&quot;
  #
  # NOTE: in case of a list of many telephone numbers, it is best using CSV files, and external-rate references.

  #
  # Specify how to calculate the cost of the call
  #

  # NOTE: Sets must be always specified after the match part.

  # These are the tranformations that can be applied on the
  # billable duration of a call.
  # The tranformations are applied in the specified order,
  # so also the order of specification is mandatory.
  # If a parameter is not specified, the default value is assumed.

  set-free-seconds: [number of seconds]
  # do not apply the cost-for-minute to these first seconds.
  # 0 is the default value.

  set-duration-discrete-increments: [number of seconds]
  # rate every specified seconds.
  # 0 is the default value.
  #
  # If the specified value is for example 3,
  # then a call with duration 0,1,2 is considered as 3 second,
  # a call with duration 3,4,5 is considered as 6 seconds, and so on.

  set-at-least-seconds: [number of seconds]
  # consider the call at least as the specified seconds

  # These are the tranformations that are applied to the cost of a call.
  # The tranformations are applied in the specified order,
  # so also the order of specification is mandatory.
  # If a parameter is not specified, the default value is assumed.

  set-cost-on-call: [1.0|imported|expected]
  # the initial cost of the call (default value is 0)
  # &quot;imported&quot; is used for CDRS imported from external sources, having already the cost/income calculated
  # &quot;expected&quot; is used for CDRS imported from external sources/providers, and force the usage of the expected cost field

  set-cost-for-minute: [1.0]
  # the cost of the call,
  # specified for every minute, otherwise the value is too low to specify,
  # but applied by default for every second of call.
  # (default value is 0)

  set-max-cost-of-call: [1.0]
  # apply this cost, if the calculated cost of the call is major than this

  set-min-cost-of-call: [1.0]
  # apply this cost, if the calculated cost of the call is less that this

  set-round-to-decimal-digits: [integer]
  # round the cost of the call to the specified digits.
  # For example 2.41, 2.44 became 2.4, and 2.45, 2.48 became 2.5, when rounding to the 1st decimal digit.
  # If left unspecified, use the maximum possible precision, without any rounding.

  set-ceil-to-decimal-digits: [integer]
  # ceil the cost of the call to the specified decimal digits.
  # For example both 2.41, 2.44, 2.48, became 2.5 when ceiling to the 1st decimal digit.
  # If left unspecified, use the maximum possible precision, without any rounding.
  # This operation is done after the round operation.
  # So it is possible round to 4 digit, and ceiling later to 3 digits.

  set-floor-to-decimal-digits: [integer]
  # floor the cost of the call to the specified decimal digits.
  # For example both 2.41, 2.44, 2.48, became 2.4, when flooring to the 1st decimal digit.
  # If left unspecified, use the maximum possible precision, without any rounding.
  # This operation is done after the ceil operation.

  rate {
    # A child rate, inherits all the sets and matches of its parent rate, and it can override them.
    # Rates can be arbitrary nested, in order to grouping rates by common characteristics.
    # For avoiding ratinng errors, if a rate has one ore more children, then one and only one of its children
    # must match the CDR with stronger priority, and it will be used for rating the CDR.
    # If there are two or more matching rates, then an error is signaled.
    # If no children match the CDR, then an error is signaled.

    id: [reference]
    # this can be a short id, because the complete rate reference name will
    # contain automatically also the parent id.
    # For example &quot;root/outgoing/emergency-telephone-numbers&quot; is a complete path of ids,
    # where the single id parts are &quot;root&quot; for the id of the initial root rate,
    # &quot;outgoing&quot; is the id of the first nested rate, and &quot;emergency-telephone-numbers&quot; is
    # the id of the final nested rate. If the final nested rate is applied to a CDR,
    # then the signaled applied rate is &quot;root/outgoing/emergency-telephone-numbers&quot;.
    # So there can be repeated &quot;id&quot; names in nested rates, because only the full
    # path id must be unique.

    [continue with another rate specification]

  }

  rate {
    [another rate specification]
  }

  # A child rate is selected only if:
  # * the parent rate is applicable (so it inherits the matches of the parent)
  # * it is applicable
  # * there is no other children rate that is applicable using stronger matches on the match-telephone-number part
  # So it is always selected the children rate with the longest matching telephone number.

  # In case of two children rates matching a telephone number with the same strength, a rating error is signaled

  external-rate {
    # this is another child rate, but of type &quot;external-rate&quot;, instead of generic &quot;rate&quot;
    #
    # An &quot;external-rate&quot; calls another rating method, specified in an external rate specification file,
    # typically a CSV file in some rating format associated to it.
    #
    # An external-rate can have no nested children rates.

    id: [reference]

    use: [rate-reference-name]
    # the name used in &quot;Rates-&gt;Rates&quot; form, for naming the external rate to call.
    # The format of the rate is specified in &quot;Rates-&gt;Rates&quot;.
    # The external rate contains additional matches, and return calc params on the CDR.

    set-cost-on-call: [parent|this|specific-value]
    # Use &quot;parent&quot; for inheriting the value of the parent rate.
    # Use &quot;this&quot; for using the value returned from the called external rate.
    # Use the specific value instead
    # This is needed because calc params must use a fixed order of specification,
    # and in case you want change two parameters with some parameter inside,
    # you must specify also if they are using the &quot;this&quot; or &quot;parent&quot; value.
    # This is applicable to all &quot;set-&quot; calc params, and not only to &quot;set-cost-on-call&quot;.

  }

}
</pre></div>
</div>
</div>
</div>
<div class="section" id="rates-with-explicit-priority">
<h3>Rates with Explicit Priority<a class="headerlink" href="#rates-with-explicit-priority" title="Permalink to this headline">¶</a></h3>
<p>By default rates are selected according the longest matched telephone
prefix. But rates can have also an explicit priority, thanks to <code class="docutils literal"><span class="pre">else</span></code>
construct. Given an example like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>rate {
  id: r1

  rate {
    id: r2
  } else {
    rate {
      id: r3
    }
  }
} else {
  rate {
    id: r4
  }
}
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">r1/r3</span></code> is applied only if:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">r1</span></code> is applicable</li>
<li><code class="docutils literal"><span class="pre">r1/r2</span></code> is not applicable</li>
<li><code class="docutils literal"><span class="pre">r1/r3</span></code> is applicable</li>
</ul>
<p><code class="docutils literal"><span class="pre">r4</span></code> is applied only if:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">r1</span></code> and its children rates are not applicable</li>
<li><code class="docutils literal"><span class="pre">r4</span></code> is applicable</li>
</ul>
<p>So rate <code class="docutils literal"><span class="pre">r1</span></code> has implicitely more priority (is always preferred)
respect rate <code class="docutils literal"><span class="pre">r4</span></code>, and the same is true for <code class="docutils literal"><span class="pre">r1/r2</span></code>, against
<code class="docutils literal"><span class="pre">r1/r3</span></code>.</p>
</div>
<div class="section" id="bundle-rates">
<h3>Bundle Rates<a class="headerlink" href="#bundle-rates" title="Permalink to this headline">¶</a></h3>
<p>A bundle-rate is a way to rate a group of calls, while certain limits
are respected. After the limits are reached, the bundle-rate can not be
anymore applied, and normal rates are applied to next calls.</p>
<p>Bundle-rates specification can be complex. So you can ask for help to
Asterisell assistance. This documentation will be improved according.</p>
<p>A bundle-rate has effect in a time-frame. For example there can be
monthly bundles, weekly bundles, and so on.</p>
<p>At the end of each bundle time-frame, the bundle-rate status is
resetted:</p>
<ul class="simple">
<li>limits are set to their initial values.</li>
<li>service-cdrs are generated.</li>
</ul>
<p>A service-cdr is a pseudo call, associated to every
organization/extension/customer affected by the bundle-rate, used for
reporting the bundle-rate cost.</p>
<p>A bundle-rate rate calls in two ways:</p>
<ul class="simple">
<li>rating the calls that are part of the bundle, with the rate
associated to the bundle-rate</li>
<li>generating the service-cdrs at the beginning of the bundle-rate
timeframe</li>
</ul>
<p>Bundle-rates can be used for specifying things like:</p>
<ul class="simple">
<li>apply a fixed cost of 10 EUR, for the first 60 minutes of mobile
calls of a month, and rate normally other calls;</li>
<li>rate the first 60 minutes of mobile calls of a month, using a
discounted cost;</li>
</ul>
<p>Up to date, bundle-rates can be used only for specifying the income of a
call, not the vendor cost.</p>
<div class="section" id="example-of-bundle-rate-specification">
<h4>Example of Bundle-Rate Specification<a class="headerlink" href="#example-of-bundle-rate-specification" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><div class="highlight"><pre><span></span>bundle-rate {
  id: monthly-flat
  service-cdr-type: Bundle Rate
  service-cdr-description: Monthly Flat: free 1 hour of mobile calls, and 2 hours of fixed-line calls.

  schedule-every: month
  schedule-from: 1
  apply-for-each: mothly-flat
  limits-are-proportionals-to-activation-date: true
  limit-on: nothing
  calls-can-be-split: true
  only-for-calls-with-a-cost: true
  set-bundle-initial-cost: 25

  rate {
    id: free-outgoing

    match-call-direction: outgoing

    rate {
      id: fixed-line

      match-communication-channel: fixed-line
      limit-on-first-seconds: 7200
      # 2 hours
    }

    rate {
      id: mobile

      match-communication-channel: mobile
      limit-on-first-seconds: 3600
      # 1 hour
    }
  }
}
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h4>Specification<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><div class="highlight"><pre><span></span>bundle-rate {
  id: [reference]

  service-cdr-type: [textual description]
  # a short textual description/name for the type of service-cdr.
  # Usually something like &quot;Bundle Rate&quot;, &quot;Bundle Service&quot;, &quot;Service&quot;, and so on.
  # This name can be shared between different bundle-rates.
  # It does not contain details about the service, but only an high level classification.

  service-cdr-description: [textual description]
  # a textual description, associated to the service-cdr,
  # describing the details of the service offered/billed from the bundle-rate,
  # in the call report, and invoices.
  # It will be generated only if the bundle-rate service-cdr cost is greather than 0.
  # It will be generated for each organization associated to the bundle-rate.
  # There will be a unique service-cdr, with the sum of all the cost of nested bundle-rates.

  #
  # Mandatory Bundle Rate Schedule Options
  #

  schedule: [monthly|weekly]
  # after each scheduling period (time-frame), the bundle rate status is resetted,
  # and the bundle-rate service-cdrs are produced.

  schedule-from: [1..28] | [Monday|Tuesday|...]
  # specify the day of the month, or the day of the week, or the time-frame in days,
  # when starting the new bundle-rate time-frame.

  #
  # Mandatory Bundle Rate Grouping Options
  #

  apply-for-each: [list of price-category]
  # This bundle-rate is applied to organizations/extensions
  # with a direct assignment to this specified price-categories.
  #
  # If an organization/extension inherits the price-category from its parent
  # organization, but it has no direct assignment,
  # then it has no a distinct bundle-rate status:
  # * there is no separate limits allocated for the extension,
  #   but the limits of the parent organization are used instead;
  # * a service-cdr is generated only for its parents with direct assignment;
  #
  # The date of price-category assignment is used for determining when the bundle-rate
  # can be applied.
  #
  # Service-cdr is generated also if there are no calls for him, inside the time-frame.

  #
  # Mandatory Bundle Rate Limit Options.
  #

  limit-on-first-calls: [number|none]
  # apply the bundle-rate only to the first specified calls, then use normal rates.
  # &quot;none&quot; for no limit on the number of calls.

  limit-on-first-seconds: [number|none]
  # apply only for calls until the specified seconds.
  # &quot;none&quot; for no limit on duration of calls.

  limits-are-proportionals-to-activation-date: [true|false]
  # true if the bundle-rate limits on an organization/extension created not at the beginning of a time-frame,
  # but after X% days, must be scaled of X%.
  #
  # If true, then also the bundle-rate costs are proportional to the activation date.
  #
  # Only the activation (starting) date is considered, but not the date on which an organization/extension change
  # price-category, and exit from the bundle-rate. The consequences are that if an organization enters
  # at day 15 into a monthly bundle-rate A, and it exits from it at day 20 entering in monthly bundle-rate B,
  # then the organization pays both the bundle A at 50%, and the bundle B at 66% for the month with the change.
  #
  # In case there are repeated assignments to the same price-category, inside the same time-frame of the bundle-rate,
  # only the first assignment is taken in account.

  calls-can-be-split: [true|false]
  # true if the duration of a call can be split between a part respecting the bundle-rate limits,
  # and another part outside these limits. The part respecting the limits, is rated using
  # the bundle-rate, while the part not respecting the limits (the residual-duration)
  # is rated using rates not associated to the bundle-rate.
  # If false, then if a call is not completely inside the bundle-rate limits, is rated using the normal rates.

  only-for-calls-with-a-cost: [true|false]
  # true for applying the bundle only to calls having a positive cost.
  # So free calls are not counted as inside the bundle.
  # This is an advantage for end customers, because they can use the bundle
  # only for calls with a cost.

  #
  # Bundle Calc Params
  #
  # These params are applied to special service-cdrs produced at the end of
  # the bundle-rate time-frame (scheduling period).
  #

  set-bundle-initial-cost: [monetary-value]
  # the initial cost of the service-cdr.
  # At this value, will be added the cost of the calls rated inside the bundle.
  # Default value: 0

  set-bundle-min-cost: [monetary-value]
  # if the total cost of the calls in the bundle
  # (excluded the &quot;initial-bundle-cost&quot;)
  # is less than this specified value,
  # thet it is set to this value.
  # If it is greater, it is leaved unchanged.
  # The rated calls will mantain their values,
  # and a minimum-cost service-cdr will be generated
  # at the end of the rating time-frame, matching the difference between
  # this minimum value, and the total cost of the calls in the bundle.
  # Default value: 0

  #
  # Rating Params
  #

  [rate-calc-params]
  # these are the params used for normal rates.
  # The calls inside the bundle will be rated using these params.

  rate {
    # this is a child-rate of the bundle-rate, and it is used for rating the calls
    # inside the bundle, and for specifying nested bundle limits.
    #
    # Children rates, can be of any admitted type for normal rates.
    #
    # The cost of the calls are associated to the root parent bundle-rate,
    # and they are taken in account for computing &quot;set-bundle-min-cost&quot;.

    id: [reference]

    [match-filters]
    # The rate can be applied only if filters are respected.
    # These are the filters used for normal rates.
    #
    # The filter &quot;match-price-category&quot; is not allowed,
    # because its semantic is in conflict with &quot;apply-for-each&quot; of the parent rate.
    # So the price-category is implicitely the same of the parent rate.

    #
    # Optional Bundle Rate Limit Options
    #

    limit-on-first-calls: [number|none]
    # For example if the parent bundle-rate, is limited to 100 calls,
    # and the chidren bundle-rate on mobile-calls is limited to 50 calls,
    # then the first 50 mobile calls decrease the limit of the parent rate
    # to 50, and of the children bundle-rate on mobile-calls to 0.
    #
    # A limit in this rate is in logical &quot;and&quot; with the limit of the parent bundle-rate.
    # So a user can place only 50 mobile calls, and if he place 25 mobile calls, he can make only
    # 75 calls because the parent limit was decreased to 75.

    limit-on-first-seconds: [number|none]
    # apply only for calls until the specified seconds.
    # The behaviour is similar to the case of &quot;limit-on-first-calls&quot;.

    #
    # Optional Bundle Calc Params.
    #

    set-bundle-initial-cost: [monetary-value]
    # default value: 0

    set-bundle-min-cost: [monetary-value]
    # default value: 0

    # NOTE: all other params of the bundle-rate can not be changed, and they are the same of the parent bundle-rate.

    #
    # Rating Params
    #

    [rate-calc-params]
    # Rate calls inside the bundle (respecting the time-frame, the match conditions, and the limits)
    # according this rate params.
    #
    # The starting params are the params of the parent rate,
    # and these params can overwrite them.

    [other-nested-children-rates]
  }

  [other-children-rates]
}
</pre></div>
</div>
</div>
</div>
<div class="section" id="nested-bundle-rates">
<h3>Nested Bundle Rates<a class="headerlink" href="#nested-bundle-rates" title="Permalink to this headline">¶</a></h3>
<p>Bundle-rates have higher priority respect normal-rates. Normal-rates are
selected only if there is no bundle-rate matching the call, or the call
is outside the bundle-rate limits.</p>
<p>First the system select the bundle-rate with the best matching, respect
other bundle-rates. It is selected the deepest bundle-rate. Then test if
the call respect the bundle-rate limits. If they are respected the
bundle-rate is applied, otherwise no other bundle-rate is applied, and
the best matching normal-rate is applied.</p>
<p>The match condition on a bundle-rate are:</p>
<ul class="simple">
<li>the call is associated (directly or indirectly) to an organization
with a direct assignment to the price-category of the bundle-rate;</li>
<li>other normal rate conditions;</li>
</ul>
</div>
<div class="section" id="residual-call-duration">
<h3>Residual Call Duration<a class="headerlink" href="#residual-call-duration" title="Permalink to this headline">¶</a></h3>
<p>If &#8220;calls-can-be-split&#8221; is set to false, then a call C is rated using
some bundle-rate, only if its duration is completely inside the limits
of the bundle-rate. Otherwise a normal rate is selected.</p>
<p>If &#8220;calls-can-be-split&#8221; is set to true, then the residual duration of
the call is calculated, in case the call duration is not entirely within
the limits of the bundle-rates. For example if call C duration is
insidie B1 limits, but partially inside B2 limits, then:</p>
<ul class="simple">
<li>bundle-C is the call derived from C, with the duration inside the
limits of B2;</li>
<li>residual-C is the call derived from C, with the duration part outside
the limits of B2;</li>
<li>bundle-C is rated using B1/B2, because it respects the limits;</li>
<li>residual-C is rated using normal rates;</li>
</ul>
</div>
<div class="section" id="nested-organizations">
<h3>Nested Organizations<a class="headerlink" href="#nested-organizations" title="Permalink to this headline">¶</a></h3>
<p>Suppose that there is this organization hierachy:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">A*</span></code></li>
<li><code class="docutils literal"><span class="pre">A/B*</span></code></li>
<li><code class="docutils literal"><span class="pre">A*/C</span></code>
where <code class="docutils literal"><span class="pre">A/B*</span></code> and <code class="docutils literal"><span class="pre">A*/C</span></code> are children of the parent organization
<code class="docutils literal"><span class="pre">A*</span></code>.</li>
</ul>
<p>Suppose that:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">A*</span></code> is directly assigned to price-category pA</li>
<li><code class="docutils literal"><span class="pre">A*/B*</span></code> is directly assigned to price-category pB</li>
<li><code class="docutils literal"><span class="pre">A*/C</span></code> is not assigned directly to any price-category, so its
inherit the price-category of <code class="docutils literal"><span class="pre">A*</span></code></li>
</ul>
<p>So we have a situation where we have nested organizations (main
organization, departments, offices, extensions), and where each part of
the organization can be assigned to a different price-category, and a
different bundle-rate.</p>
<p>The rating method, favours always bundle-rates, respect normal rates.
When bundle-rates can not be applied, it tries with normal rates.</p>
<p>So for a call associated to <code class="docutils literal"><span class="pre">A*/C</span></code>, it tries to apply the bundle-rate
associated to <code class="docutils literal"><span class="pre">A*</span></code>, because <code class="docutils literal"><span class="pre">C</span></code> has no bundle-rate, but <code class="docutils literal"><span class="pre">A*</span></code> is
subscribed to pA bundle-rate, and so it must take advantage of this for
all its extensions. If the bundle-rate can be applied to <code class="docutils literal"><span class="pre">A*/C</span></code>, then
the limits of <code class="docutils literal"><span class="pre">A*</span></code> are updated.</p>
<p>For a call associated to <code class="docutils literal"><span class="pre">A*/B*</span></code> organization, it tries to apply the
bundle-rate associated to <code class="docutils literal"><span class="pre">pB</span></code> price-category, because organization
<code class="docutils literal"><span class="pre">p/B*</span></code> is associated directly to <code class="docutils literal"><span class="pre">pB</span></code>. If the <code class="docutils literal"><span class="pre">pB</span></code> bundle-rate can
be applied to <code class="docutils literal"><span class="pre">A*/B*</span></code>, then only the limits of <code class="docutils literal"><span class="pre">A*/B*</span></code> are updated,
while <code class="docutils literal"><span class="pre">A*</span></code> is not updated.</p>
<p>If there is no bundle-rate on <code class="docutils literal"><span class="pre">pB</span></code>, or <code class="docutils literal"><span class="pre">A*/B*</span></code> has consumed all its
bundle-limits, then the system tries rating the call using the
bundle-rate associated to price-category <code class="docutils literal"><span class="pre">pA</span></code>, because <code class="docutils literal"><span class="pre">A/B*</span></code> is a
children organization of <code class="docutils literal"><span class="pre">A</span></code>, and <code class="docutils literal"><span class="pre">A</span></code> is &#8220;subscribed&#8221; to a
bundle-rate.</p>
<p>If there is no bundle-rate on <code class="docutils literal"><span class="pre">pA</span></code>, or <code class="docutils literal"><span class="pre">A*</span></code> has used all its limits,
then normal-rates are used.</p>
<p>Summing up:</p>
<ul class="simple">
<li>a bundle rate can be applied to all children extensions;</li>
<li>a bundle rate generate a service-cdr (a cost) for each extension with
a direct price-category assignation, corresponding to a bundle-rate;</li>
<li>an extension with a direct association to a bundle-rate
price-category, has its own limits, also because it pays for them;</li>
<li>if an extension has used all its bundle-rate limits, then the parent
organization bundle-rate limits can be used, and they can be
associated to a different type of bundle-rate, because the
bundle-rate hireararchy is distinct from the organization hierarchy,
and extensions can have different price-categories respect the parent
organization;</li>
</ul>
</div>
<div class="section" id="limitations">
<h3>Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h3>
<p>Up to date bundle-rates:</p>
<ul class="simple">
<li>can be used only for specifying incomes for customers, and not cost
for vendors;</li>
<li>do not accept children bundle-rates with scheduling periods
(time-frames) different from parent bundle-rate;</li>
<li>do not accept children bundle-rates with &#8220;calls-can-be-split&#8221; value
different from parent bundle-rate;</li>
</ul>
</div>
<div class="section" id="changes-of-rates">
<h3>Changes of Rates<a class="headerlink" href="#changes-of-rates" title="Permalink to this headline">¶</a></h3>
<p>In Asterisell rates are modified adding a new rate plan, with an initial
validity date. All the calls before this date are rated using the old
version of the rating plan, while calls from the specified date, are
rated using the new version.</p>
<p>In this way it is possible re-rating old calls, using the old version of
the rating plans.</p>
</div>
<div class="section" id="changes-of-bundle-rates">
<h3>Changes of Bundle Rates<a class="headerlink" href="#changes-of-bundle-rates" title="Permalink to this headline">¶</a></h3>
<p>A Bundle Rate can change.</p>
<p>The id name of the rate is used for merging calls rated with
bundle-rates of the previous rating plan. A new bundle-rate with the
same name of a previous defined bundle-rate redefine the bundle-rate. If
there are missing names, the system signal the error.</p>
<p>We suppose that:</p>
<ul class="simple">
<li>&#8220;2014-01-15&#8221; is the date of when a new bundle-rate plan became
active,</li>
<li>&#8220;A&#8221; is the previous version of the bundle-rate plan</li>
<li>&#8220;B&#8221; is the new version of the bundle-rate plan</li>
</ul>
<p>Calls are rated in this way:</p>
<ul class="simple">
<li>all organizations assigned to the bundle-rate after &#8220;2014-01-15&#8221;
(inclusive), use the new rating plan &#8220;B&#8221; limits, and service-cdrs
cost</li>
<li>all organizations assigned to the bundle-rate before &#8220;2014-01-15&#8221;,
use the old rating plan &#8220;A&#8221; limits and service-cdrs cost, until the
bundle time frame of &#8220;A&#8221; end</li>
<li>at the end of the time frame of &#8220;A&#8221;, all organizations use the
bundle-rate plan &#8220;B&#8221;</li>
<li>all calls after &#8220;2014-01-15&#8221; are rated according the new bundle
rating plan &#8220;B&#8221;, so only the limits, and service-cdrs are generated
according the old plan &#8220;A&#8221;</li>
</ul>
<p>The reasons of these rules are that an organization accepting a bundle
rate plan, must follow the same plan until the end of the bundle rate
time frame, but that rated calls must use always the most recent plan.</p>
</div>
</div>
<div class="section" id="customization-of-messages-to-customers">
<h2>Customization of Messages to Customers<a class="headerlink" href="#customization-of-messages-to-customers" title="Permalink to this headline">¶</a></h2>
<div class="section" id="type-of-messages">
<h3>Type of Messages<a class="headerlink" href="#type-of-messages" title="Permalink to this headline">¶</a></h3>
<p>Customers can receive from Asterisell:</p>
<ul class="simple">
<li>invoices</li>
<li>call report details</li>
<li>warning in case the costs are higher than expected/planned costs</li>
<li>and so on...</li>
</ul>
<p>Reports and invoices are attached to an email. The email can be
customized. Every nation, culture, company can have a different taste
and approach toward customers, so for sure there is no a default message
that is good for all different usage scenario.</p>
</div>
<div class="section" id="where-customize">
<h3>Where Customize<a class="headerlink" href="#where-customize" title="Permalink to this headline">¶</a></h3>
<p>During initial testing of messages and application you can set in the
Asterisell Management Tool, the option
<code class="docutils literal"><span class="pre">send_emails_to_these_users_instead_of_original_receiver</span></code>, for
redirecting all the emails originally directed to customers to an
internal test email.</p>
<div class="section" id="adding-new-type-of-reports">
<span id="id4"></span><h4>Adding New Type of Reports<a class="headerlink" href="#adding-new-type-of-reports" title="Permalink to this headline">¶</a></h4>
<p>You can define new type of reports adding source code under
<code class="docutils literal"><span class="pre">apps/asterisell/lib/jobs/reports</span></code>, then add them into the Fabric
variable <code class="docutils literal"><span class="pre">custom_reports</span></code>, so they can be selected for scheduling and
then generated.</p>
</div>
<div class="section" id="warning-emails-for-high-call-costs">
<h4>Warning Emails for High Call Costs<a class="headerlink" href="#warning-emails-for-high-call-costs" title="Permalink to this headline">¶</a></h4>
<p>You can customize
<code class="docutils literal"><span class="pre">apps/asterisell/lib/jobs/checks/GenerateMailWarningCustomerForHighCallCost.php</span></code>
in case you are sending emails to customers for high call costs.</p>
</div>
</div>
<div class="section" id="adding-payment-terms-and-notes-to-invoices">
<h3>Adding Payment Terms and Notes to Invoices<a class="headerlink" href="#adding-payment-terms-and-notes-to-invoices" title="Permalink to this headline">¶</a></h3>
<p>You can customize the notes, payments terms, and so on, added inside
invoices, in the <code class="docutils literal"><span class="pre">Params</span> <span class="pre">-&gt;</span> <span class="pre">Params</span></code> Web form of the application.</p>
</div>
<div class="section" id="email-message-and-attachment-name">
<h3>Email Message and Attachment Name<a class="headerlink" href="#email-message-and-attachment-name" title="Permalink to this headline">¶</a></h3>
<p>You can customize the message of the emails containing invoices and
other reports:</p>
<ul class="simple">
<li>select the report template used for generating them, in the
<code class="docutils literal"><span class="pre">Reports</span> <span class="pre">-&gt;</span> <span class="pre">All</span> <span class="pre">Reports</span></code></li>
<li>in the email section of a report, you can customize/specify the
messages to use in the email containing the report</li>
</ul>
<p>You can customize email messages both in the scheduler Web form, or you
can customize the message also for a single specific report/invoice.</p>
</div>
</div>
<div class="section" id="notifications-to-administrators-and-accountants">
<span id="notifications"></span><h2>Notifications to Administrators and Accountants<a class="headerlink" href="#notifications-to-administrators-and-accountants" title="Permalink to this headline">¶</a></h2>
<div class="section" id="type-of-errors">
<h3>Type of Errors<a class="headerlink" href="#type-of-errors" title="Permalink to this headline">¶</a></h3>
<p>Asterisell generate errors in the error table
<code class="docutils literal"><span class="pre">Status</span> <span class="pre">-&gt;</span> <span class="pre">Current</span> <span class="pre">Problems</span></code>.</p>
<p>Errors are also signaled by email, generating an error report, that is
sent to administrators with the role:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">Notified</span> <span class="pre">for</span> <span class="pre">warning</span> <span class="pre">errors</span></code></li>
<li><code class="docutils literal"><span class="pre">Notified</span> <span class="pre">for</span> <span class="pre">errors</span></code></li>
<li><code class="docutils literal"><span class="pre">Notified</span> <span class="pre">for</span> <span class="pre">critical</span> <span class="pre">errors</span></code></li>
</ul>
</div>
<div class="section" id="normal-administrator">
<h3>Normal Administrator<a class="headerlink" href="#normal-administrator" title="Permalink to this headline">¶</a></h3>
<p>You can define a normal administrator with these roles:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">Notified</span> <span class="pre">for</span> <span class="pre">warning</span> <span class="pre">errors</span></code></li>
<li><code class="docutils literal"><span class="pre">Notified</span> <span class="pre">for</span> <span class="pre">errors</span></code></li>
<li><code class="docutils literal"><span class="pre">Notified</span> <span class="pre">for</span> <span class="pre">critical</span> <span class="pre">errors</span></code></li>
</ul>
<p>He will be advised of all type of errros.</p>
</div>
<div class="section" id="emergency-email">
<h3>Emergency Email<a class="headerlink" href="#emergency-email" title="Permalink to this headline">¶</a></h3>
<p>You can define another account, with a distinct email, and with only
this role:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">Notified</span> <span class="pre">for</span> <span class="pre">critical</span> <span class="pre">errors</span></code></li>
</ul>
<p>In this way you can be sure that the email is &#8220;fired&#8221; only in case of
very important problems.</p>
</div>
<div class="section" id="security-problems">
<h3>Security Problems<a class="headerlink" href="#security-problems" title="Permalink to this headline">¶</a></h3>
<p>Critical errors are fired in case of:</p>
<ul class="simple">
<li>high call costs surpassing the limit of an account of more than two
time</li>
<li>there are too much calls not rated</li>
<li>there is a critical erorr, avoiding the processing of CDRs</li>
<li>and so on</li>
</ul>
</div>
<div class="section" id="accountant">
<h3>Accountant<a class="headerlink" href="#accountant" title="Permalink to this headline">¶</a></h3>
<p>You can generate summary reports in Asterisell to send only to system
administrator with role <code class="docutils literal"><span class="pre">Accountant</span></code>.</p>
</div>
</div>
<div class="section" id="configurations-of-reports">
<h2>Configurations of Reports<a class="headerlink" href="#configurations-of-reports" title="Permalink to this headline">¶</a></h2>
<p>Report configurations is not an easy process, because there are many
configuration settings.</p>
<p>Asterisell will install with some predefined reports. The admin can
customize them later.</p>
<div class="section" id="scheduled-reports">
<h3>Scheduled Reports<a class="headerlink" href="#scheduled-reports" title="Permalink to this headline">¶</a></h3>
<p>The report workflow is usually this:</p>
<ul class="simple">
<li>define report templates</li>
<li>generate them</li>
<li>when they are ok, use them as template, for a report scheduler:<ul>
<li>create a new report scheduler</li>
<li>link the scheduler to the report template</li>
<li>specify the date of the first scheduling generation to run</li>
<li>run the first batch of reports, pressing the <code class="docutils literal"><span class="pre">Generate</span> <span class="pre">Reports</span></code>
button</li>
<li>all next run of the report scheduler will be executed
automatically</li>
</ul>
</li>
<li>reports will be generated according the scheduling:<ul>
<li>each report scheduling generation, will produce a report-set</li>
<li>each report-set contains all the generated reports of the same
type, on the same time-frame, for example all the invoices of all
customers</li>
<li>the admin can review a report set</li>
<li>until the admin do not confirm a report-set, the reports are not
sent to the customers/users</li>
<li>the admin is advised, if after generation, and before sending, the
calls associated to the report are modified, and it is obliged to
regenerate it</li>
</ul>
</li>
</ul>
<p>So after initial configurations, the generation of reports is
automatized.</p>
</div>
<div class="section" id="examples-of-scheduled-reports">
<h3>Examples of Scheduled Reports<a class="headerlink" href="#examples-of-scheduled-reports" title="Permalink to this headline">¶</a></h3>
<p>The initial demo instance, is configured with some common scheduled
reports.</p>
</div>
<div class="section" id="billing-reports">
<h3>Billing Reports<a class="headerlink" href="#billing-reports" title="Permalink to this headline">¶</a></h3>
<p>Billing reports (legal reports) are important, because they are also
used for determining the official call date: the calls before this call
date are never automatically rerated if there are changes in rating
params.</p>
<p>So at least one billing report should be defined in the system.</p>
</div>
<div class="section" id="customization-of-invoices">
<h3>Customization of Invoices<a class="headerlink" href="#customization-of-invoices" title="Permalink to this headline">¶</a></h3>
<p>See <a class="reference internal" href="#adding-new-type-of-reports"><span>Adding New Type of Reports</span></a>.</p>
</div>
<div class="section" id="sending-of-reports">
<h3>Sending of Reports<a class="headerlink" href="#sending-of-reports" title="Permalink to this headline">¶</a></h3>
<p>Reports are sent to proper billable users. If an user has no associated
email, the application will warn the administrator. When the email is
specified, the reports will be sent automatically.</p>
<p><a class="reference internal" href="#notifications"><span>Notifications to Administrators and Accountants</span></a> describes how sending reports to special users.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Configuration and Usage</a><ul>
<li><a class="reference internal" href="#application-recurring-concepts">Application Recurring Concepts</a></li>
<li><a class="reference internal" href="#configuration-of-the-cdr-rating-process">Configuration of the CDR Rating Process</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#paid-support-for-initial-configuration">Paid Support for Initial Configuration</a></li>
<li><a class="reference internal" href="#cdrs-providers">CDRs Providers</a></li>
<li><a class="reference internal" href="#cdrs-file-name">CDRs File Name</a></li>
<li><a class="reference internal" href="#cdrs-status-files">CDRs Status Files</a></li>
<li><a class="reference internal" href="#manual-importing-of-cdrs-files">Manual Importing of CDRs files</a></li>
<li><a class="reference internal" href="#automatic-importing-of-cdrs-files">Automatic Importing of CDRs files</a></li>
<li><a class="reference internal" href="#how-cdrs-source-file-are-saved-internally">How CDRs Source File are Saved Internally</a></li>
<li><a class="reference internal" href="#how-importing-from-csv-files">How Importing From CSV Files</a></li>
<li><a class="reference internal" href="#pseudo-csv-file">Pseudo CSV File</a></li>
<li><a class="reference internal" href="#how-importing-from-collector-table">How Importing From Collector Table</a><ul>
<li><a class="reference internal" href="#workflow-of-cdrs-processing">Workflow of CDRs Processing</a></li>
<li><a class="reference internal" href="#is-exported-to-asterisell-flag-field">&#8220;is_exported_to_asterisell&#8221; flag field</a></li>
<li><a class="reference internal" href="#tables-on-external-databases">Tables on External Databases</a></li>
<li><a class="reference internal" href="#tables-on-the-same-host-and-database-server">Tables on the same Host and Database Server</a></li>
<li><a class="reference internal" href="#fix-errors-in-imported-cdrs">Fix Errors in Imported CDRs</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#specification-of-rating-plans">Specification of Rating Plans</a></li>
<li><a class="reference internal" href="#call-reporting-mode">Call Reporting Mode</a></li>
<li><a class="reference internal" href="#automatic-rerating-of-calls">Automatic Rerating of Calls</a></li>
<li><a class="reference internal" href="#tutorial-on-csv-rates">Tutorial on CSV Rates</a></li>
<li><a class="reference internal" href="#tutorial-on-main-rate-plans">Tutorial on Main Rate Plans</a><ul>
<li><a class="reference internal" href="#cost-rates">Cost Rates</a><ul>
<li><a class="reference internal" href="#free-incoming-and-internal-calls">Free Incoming and Internal Calls</a></li>
<li><a class="reference internal" href="#multiple-vendors">Multiple Vendors</a></li>
</ul>
</li>
<li><a class="reference internal" href="#income-rates">Income Rates</a><ul>
<li><a class="reference internal" href="#id1">Free Incoming and Internal Calls</a></li>
<li><a class="reference internal" href="#rate-according-customer-price-category">Rate according Customer Price Category</a></li>
</ul>
</li>
<li><a class="reference internal" href="#todo-continue">TODO continue</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rate-plan-specification-language">Rate Plan Specification Language</a><ul>
<li><a class="reference internal" href="#normal-rates">Normal Rates</a><ul>
<li><a class="reference internal" href="#specification">Specification</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rates-with-explicit-priority">Rates with Explicit Priority</a></li>
<li><a class="reference internal" href="#bundle-rates">Bundle Rates</a><ul>
<li><a class="reference internal" href="#example-of-bundle-rate-specification">Example of Bundle-Rate Specification</a></li>
<li><a class="reference internal" href="#id3">Specification</a></li>
</ul>
</li>
<li><a class="reference internal" href="#nested-bundle-rates">Nested Bundle Rates</a></li>
<li><a class="reference internal" href="#residual-call-duration">Residual Call Duration</a></li>
<li><a class="reference internal" href="#nested-organizations">Nested Organizations</a></li>
<li><a class="reference internal" href="#limitations">Limitations</a></li>
<li><a class="reference internal" href="#changes-of-rates">Changes of Rates</a></li>
<li><a class="reference internal" href="#changes-of-bundle-rates">Changes of Bundle Rates</a></li>
</ul>
</li>
<li><a class="reference internal" href="#customization-of-messages-to-customers">Customization of Messages to Customers</a><ul>
<li><a class="reference internal" href="#type-of-messages">Type of Messages</a></li>
<li><a class="reference internal" href="#where-customize">Where Customize</a><ul>
<li><a class="reference internal" href="#adding-new-type-of-reports">Adding New Type of Reports</a></li>
<li><a class="reference internal" href="#warning-emails-for-high-call-costs">Warning Emails for High Call Costs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#adding-payment-terms-and-notes-to-invoices">Adding Payment Terms and Notes to Invoices</a></li>
<li><a class="reference internal" href="#email-message-and-attachment-name">Email Message and Attachment Name</a></li>
</ul>
</li>
<li><a class="reference internal" href="#notifications-to-administrators-and-accountants">Notifications to Administrators and Accountants</a><ul>
<li><a class="reference internal" href="#type-of-errors">Type of Errors</a></li>
<li><a class="reference internal" href="#normal-administrator">Normal Administrator</a></li>
<li><a class="reference internal" href="#emergency-email">Emergency Email</a></li>
<li><a class="reference internal" href="#security-problems">Security Problems</a></li>
<li><a class="reference internal" href="#accountant">Accountant</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configurations-of-reports">Configurations of Reports</a><ul>
<li><a class="reference internal" href="#scheduled-reports">Scheduled Reports</a></li>
<li><a class="reference internal" href="#examples-of-scheduled-reports">Examples of Scheduled Reports</a></li>
<li><a class="reference internal" href="#billing-reports">Billing Reports</a></li>
<li><a class="reference internal" href="#customization-of-invoices">Customization of Invoices</a></li>
<li><a class="reference internal" href="#sending-of-reports">Sending of Reports</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="management.html"
                        title="previous chapter">Management</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="FAQ.html"
                        title="next chapter">FAQ and HOWTOS</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/usage.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="FAQ.html" title="FAQ and HOWTOS"
             >next</a> |</li>
        <li class="right" >
          <a href="management.html" title="Management"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Asterisell 5 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, Massimo Zaniboni.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
  </body>
</html>